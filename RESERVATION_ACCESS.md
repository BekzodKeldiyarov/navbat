# Система доступа к резервации

## Обзор

Система резервации теперь защищена SMS верификацией. Пользователи должны пройти верификацию номера телефона перед доступом к форме записи на прием.

## Как это работает

### 1. Первый доступ
- Пользователь переходит на страницу `/reservation`
- Система проверяет наличие `access_token`
- Если токен отсутствует, показывается форма SMS верификации

### 2. SMS верификация
- Пользователь вводит номер телефона
- Нажимает кнопку "SMS" для отправки кода
- Вводит полученный SMS код
- После успешной верификации генерируется `access_token`

### 3. Доступ к резервации
- С `access_token` пользователь получает доступ к полной форме резервации
- Все шаги резервации доступны
- SMS данные автоматически подставляются в форму

## Техническая реализация

### Хранение данных
- `access_token` - токен доступа (localStorage)
- `sms_session_id` - ID SMS сессии (localStorage)
- `sms_password` - SMS код (localStorage)

### API интеграция
- **Отправка SMS**: `/proxy/send-sms`
- **Регистрация**: `/proxy/registration`
- **Сохранение расписания**: `/proxy/save-schedule`

### Компоненты
- `ReservationPage` - основная страница с логикой верификации
- `PatientRegistrationStep` - обновлен для использования существующего токена
- `StepContent` - отображение шагов резервации

## Безопасность

### Middleware
- Файл `middleware.ts` проверяет доступ к `/reservation`
- Перенаправляет неавторизованных пользователей на главную страницу

### Валидация
- Проверка SMS кода перед генерацией токена
- Проверка токена на каждом шаге резервации

## Пользовательский опыт

### Главная страница
- Кнопка "Записаться на прием" показывает статус авторизации
- Если верификация не пройдена, кнопка неактивна
- Показывается уведомление о необходимости верификации

### Страница резервации
- Четкий процесс верификации с понятными шагами
- Возможность выхода из системы
- Автоматическое заполнение SMS данных

## Тестирование

### Сценарии
1. **Новый пользователь**: переход на `/reservation` → SMS верификация → доступ к резервации
2. **Авторизованный пользователь**: прямой доступ к резервации
3. **Выход из системы**: сброс токена и возврат к верификации

### Отладка
- Проверка localStorage для токенов
- Логи в консоли браузера
- Проверка API ответов

## Развертывание

### Требования
- Обновленный proxy сервер с API `/send-sms`
- Next.js middleware
- Обновленные компоненты React

### Проверка
1. Запустить proxy сервер
2. Проверить работу SMS API
3. Протестировать полный flow верификации
4. Проверить защиту маршрута `/reservation`

## Будущие улучшения

- Интеграция с реальной системой аутентификации
- Сохранение токенов в безопасных cookies
- Двухфакторная аутентификация
- Автоматическое обновление токенов
- Логирование попыток доступа
