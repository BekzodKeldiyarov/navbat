# Поток проекта Navbat

## Обзор пользовательского потока

Данный документ описывает полный пользовательский поток приложения Navbat, от первого посещения до завершения записи на прием.

## 1. Первое посещение (Unauthenticated User)

### 1.1 Главная страница (`/`)
```
Пользователь заходит на сайт
↓
Отображается главная страница с:
- Hero секция с описанием сервиса
- Две основные кнопки действий
- Список медицинских категорий
↓
Пользователь выбирает действие
```

**Доступные действия:**
- **Поиск по категориям** → Переход на `/categories`
- **Войти по номеру телефона** → Переход на `/login`

### 1.2 Страница категорий (`/categories`)
```
Пользователь видит список медицинских категорий
↓
Может развернуть подкатегории (клик по категории)
↓
Выбирает нужную категорию
↓
Переход на страницу клиник в категории
```

**Функциональность:**
- Древовидная структура категорий
- Поиск по названию
- Кэширование развернутых категорий
- Ленивая загрузка подкатегорий

### 1.3 Страница клиник в категории (`/categories?category={id}`)
```
Отображается список клиник в выбранной категории
↓
Пользователь выбирает клинику
↓
Переход на страницу клиники
```

## 2. Процесс аутентификации

### 2.1 Страница входа (`/login`)
```
Пользователь переходит на страницу входа
↓
Вводит номер телефона в формате 998XXXXXXXXX
↓
Нажимает "Отправить SMS"
↓
API отправляет SMS код на телефон
↓
Отображается поле для ввода SMS кода
↓
Пользователь вводит полученный код
↓
Нажимает "Войти"
↓
API проверяет код и возвращает access_token
↓
Токен сохраняется в localStorage
↓
Происходит автоматическое перенаправление на /reservations
```

**Валидация:**
- Формат номера телефона (998XXXXXXXXX)
- Длина SMS кода (6 символов)
- Только цифры в SMS коде

**Обработка ошибок:**
- Неверный формат номера
- Ошибка отправки SMS
- Неверный SMS код
- Ошибка сервера

### 2.2 Повторная отправка SMS
```
Если SMS не пришел или код неверный
↓
Пользователь нажимает "Отправить код заново"
↓
Очищается поле SMS кода
↓
Отправляется новый SMS
↓
Обновляется SMS сессия
```

## 3. Аутентифицированный пользователь

### 3.1 Главная страница (после входа)
```
Пользователь видит дополнительные кнопки:
- "Показать мои записи" → Переход на /reservations
- "Выйти из системы" → Выход и возврат на главную
```

### 3.2 Страница записей (`/reservations`)
```
Отображается список существующих записей пользователя
↓
Если записей нет - предложение создать новую
↓
Кнопка "Создать новую запись" → Переход на /reservation
```

**Функциональность:**
- Загрузка записей по access_token
- Отображение деталей записи
- Возможность отмены записи
- Фильтрация по дате/статусу

## 4. Процесс создания записи

### 4.1 Страница создания записи (`/reservation`)
```
Многошаговый процесс создания записи:
```

#### Шаг 1: Выбор клиники
```
Пользователь выбирает клинику из списка
↓
Отображается информация о клинике
↓
Кнопка "Продолжить" → Следующий шаг
```

#### Шаг 2: Выбор врача
```
Отображается список врачей в клинике
↓
Для каждого врача показывается:
- ФИО
- Фото
- Время приема
- Расписание
↓
Пользователь выбирает врача
↓
Кнопка "Продолжить" → Следующий шаг
```

#### Шаг 3: Выбор времени
```
Отображается календарь с доступными датами
↓
Для выбранной даты показываются временные слоты
↓
Пользователь выбирает удобное время
↓
Кнопка "Продолжить" → Следующий шаг
```

#### Шаг 4: Ввод данных пациента
```
Форма для ввода:
- Имя (обязательно)
- Фамилия (обязательно)
- Отчество (необязательно)
- Номер телефона (автозаполнение)
↓
Валидация всех полей
↓
Кнопка "Продолжить" → Следующий шаг
```

#### Шаг 5: Подтверждение SMS
```
Отправляется SMS код на номер телефона
↓
Пользователь вводит код
↓
Валидация SMS кода
↓
Кнопка "Подтвердить" → Следующий шаг
```

#### Шаг 6: Подтверждение записи
```
Отображается сводка записи:
- Клиника
- Врач
- Дата и время
- Данные пациента
↓
Кнопка "Подтвердить запись" → Создание записи
```

### 4.2 Создание записи
```
API запрос на создание записи
↓
Если успешно:
- Запись сохраняется в базе
- Отображается сообщение об успехе
- Перенаправление на /reservations
↓
Если ошибка:
- Отображение ошибки
- Возможность повторить
```

## 5. Управление записями

### 5.1 Просмотр записи
```
В списке записей пользователь может:
- Просмотреть детали записи
- Отменить запись
- Изменить время (если доступно)
```

### 5.2 Отмена записи
```
Пользователь нажимает "Отменить"
↓
Подтверждение отмены
↓
API запрос на отмену
↓
Обновление списка записей
```

## 6. Обработка ошибок

### 6.1 Ошибки аутентификации
```
- Неверный номер телефона
- Ошибка отправки SMS
- Неверный SMS код
- Истекший токен
- Ошибка сервера
```

### 6.2 Ошибки API
```
- Сетевые ошибки
- Ошибки валидации
- Ошибки сервера
- Таймауты
```

### 6.3 Ошибки React
```
- Ошибки рендеринга
- Ошибки в компонентах
- Graceful fallback UI
```

## 7. Технический поток

### 7.1 Инициализация приложения
```
App → Layout → AuthProvider → ErrorBoundary → Pages
↓
Проверка localStorage на наличие access_token
↓
Инициализация состояния аутентификации
```

### 7.2 Загрузка данных
```
Component → Hook → ApiClient → API → State Update → Re-render
↓
Кэширование в localStorage
↓
Обработка ошибок
↓
Loading состояния
```

### 7.3 Навигация
```
Next.js Router → Page Component → Data Fetching → Render
↓
Автоматическое перенаправление после аутентификации
↓
Защищенные маршруты
```

## 8. Состояния приложения

### 8.1 Loading состояния
```
- Загрузка категорий
- Загрузка клиник
- Загрузка врачей
- Отправка SMS
- Проверка SMS
- Создание записи
```

### 8.2 Error состояния
```
- Ошибки валидации
- Ошибки сети
- Ошибки сервера
- Ошибки аутентификации
```

### 8.3 Success состояния
```
- SMS отправлен
- Вход выполнен
- Запись создана
- Запись отменена
```

## 9. Кэширование и оптимизация

### 9.1 Кэширование данных
```
- Категории в localStorage
- Развернутые категории
- Дочерние категории
- Токены аутентификации
```

### 9.2 Оптимизация производительности
```
- Ленивая загрузка компонентов
- Мемоизация хуков
- Оптимизация перерендеров
- Retry логика для API
```

## 10. Безопасность

### 10.1 Валидация данных
```
- Проверка форматов на клиенте
- Валидация API запросов
- Санитизация пользовательского ввода
```

### 10.2 Аутентификация
```
- JWT токены
- Автоматическое добавление заголовков
- Проверка валидности токенов
```

---

Этот поток обеспечивает:
- **Простота использования** - понятные шаги для пользователя
- **Безопасность** - валидация на всех этапах
- **Надежность** - обработка ошибок и fallback UI
- **Производительность** - кэширование и оптимизация
- **Масштабируемость** - легко добавлять новые функции
